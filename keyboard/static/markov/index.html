<!DOCTYPE html>
<html>
<head>
  <title>Markov Chains</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
  <link href='OpenSanslocal.css' rel='stylesheet' type='text/css'>
  <link href="style.css" type="text/css" rel="stylesheet">
  <script src="d3.v3.js" charset="utf-8"></script>
  <script src="vector.js"></script>
  <script src="angular.min.js" charset="utf-8"></script>
  <style>
    body {
      background-color: #222;
      color: white;
    }
    .st-diagram {
      pointer-events: none;
      position: absolute;
      left: 0;
      width: 100%;
      z-index: 1;
    }
    .st-diagram .nodes {
      pointer-events: all;
    }

  </style>
</head>
<body ng-app="myApp" ng-controller="MainCtrl">
  <st-diagram center="diagramCenter" states="states"
  transition-matrix="transitionMatrix" duration="duration"
  selected-transition="selectedTransition"></st-diagram>
</div>
<!--
<div class="matrixInput">
  <textarea ng-class="{ 'valid' : validTransitionMatrix }"
  ng-model="transitionMatrixJSON">{{transitionMatrix | json}}</textarea>
</div>
<div class="statesNameInput">
  <textarea ng-model="nameMatrixJSON" 
  placeholder='Enter labels for all states in the following format: 
  ["StateA", "StateB"]'>{{nameMatrix}}</textarea>
</div>
-->
</body>

<script>

  var myApp = angular.module('myApp', []);

  myApp.controller('MainCtrl', function($scope, utils, $window) {
    angular.element($window).on('resize', function() { $scope.$apply(); });
    $scope.diagramCenter = [0.5, 0.5];
    $scope.isSelectedTransition = function(i, j) {
      return !!$scope.selectedTransition;
      if (!$scope.selectedTransition) return false;
      return $scope.selectedTransition[0] === i
      && $scope.selectedTransition[1] === j;
    };
    $scope.speedRange = 0.5;
    $scope.$watch('speedRange', function(speed) {
      $scope.duration = 2000 / +speed;
    });

  // Read in the names of all states 
  $scope.nameMatrixJSON = JSON.stringify($scope.nameMatrix);
  var grammarBook;
  $scope.$watch('nameMatrixJSON', function(str) {
    try{
      grammarBook= JSON.parse(str);
      $scope.nameMatrix = grammarBook;
      if(Object.keys(grammarBook).length == $scope.transitionMatrix.length){
        var hash = utils.getHash();
        var tm;
        if(hash)
          tm = hash.tm;
        utils.setHash({ tm: tm, grammar: grammarBook});
      } 
    } catch(e) {}
  });

  $scope.updateTransitionMatrix = function(matrix) {
	var prev = $scope.transitionMatrix;
    $scope.transitionMatrix = matrix;
    if(!$scope.states || matrix.length !== prev.length) {
      $scope.states = matrix.map(function(d, i) {
        if(grammarBook && i < Object.keys(grammarBook).length){
          return { label: grammarBook[i], index: i };
        } else {
          return { label: String.fromCharCode(65 + i), index: i};
        }
      });
    }
    // Session Storage for page refreshing
    var grammar;
    var hash = utils.getHash();
    if(hash && hash.grammar) grammar = hash.grammar;
    utils.setHash({ tm: matrix, grammar: grammar });
  };

  var hash = utils.getHash();
  if(hash && hash.grammar) {
    grammarBook = hash.grammar;
    //~ console.log("hash grammar :",hash.grammar);
    //~ $scope.nameMatrix = hash.grammar;
    $scope.nameMatrix = ['--', 'do1', 'do#1', 'ré1', 'mib1', 'mi1', 'fa', 'fa#', 'sol', 'sol#', 'la', 'sib', 'si', 'do2', 'do#2', 'ré2', 'mib2', 'mi2'];
  }
  if(hash && hash.tm) $scope.updateTransitionMatrix(hash.tm);
  else $scope.updateTransitionMatrix([[0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5]]);
  //~ else $scope.updateTransitionMatrix([
    //~ [0.5, 0.5],
    //~ [0.5, 0.5]
    //~ ]);
  

  // Validify the inputted matrix
$scope.transitionMatrixJSON = JSON.stringify($scope.transitionMatrix)
  .replace(/\],/gm, '],\n');
$scope.$watch('transitionMatrixJSON', function(str) {
  var valid = false;
  try{ 
      // Parse from string to a matrix
      var matrix = JSON.parse(str);
      valid = matrix[0].length === matrix.length;
      var sum = matrix.reduce(function(c, row) {
        return c + row.reduce(function(p, c){ return p + c; }, 0);
      }, 0);
      var r = sum / matrix.length;
      // valid = valid && r < (1 + 1e-9) && r > (1 - 1e-9);
      if (valid) {
        $scope.updateTransitionMatrix(matrix);
      }
    }catch(e) {}
    $scope.validTransitionMatrix = valid;
  });
  
  // receive POST from parent window
	window.onmessage = function(e){
			//~ $scope.nameMatrix = e.data.names;
			var needReload = ($scope.transitionMatrix.length != e.data.names.length);
			console.log("reloading ?", needReload);
			$scope.nameMatrixJSON = JSON.stringify(e.data.names);		
			$scope.updateTransitionMatrix(e.data.weights);
			//~ $scope.transitionMatrixJSON = JSON.stringify(e.data.weights);
			$scope.$apply();
			if (needReload) window.location.reload();
};
});
</script>
<script src="common.js" charset="utf-8"></script>
</html>

